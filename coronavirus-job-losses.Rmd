---
title: "coronavirus-job-losses"
author: "Joe Yerardi"
date: "3/23/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set working directory
setwd("/home/joe/Projects/coronavirus-job-losses//")
```

```{r import packages, echo = FALSE}
library("dplyr")
library("ggplot2")
library("htmltools")
library("purrr")
library("readr")
library("sf")
library("stringr")
library("tidyr")
library("leaflet")
library("tigris")
```

```{r import data, echo = FALSE}
# County-level data

# Import 2019 third quarter data from (BLS's Quarterly Census of Employment and Wages (QCEW))[https://data.bls.gov/cew/apps/data_views/data_views.htm#tab=Tables]

# Total Covered, 10 Total, all industries, All Counties 2019 Third Quarter, All establishment sizes
counties_all_industries <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/10.csv") %>% 
  filter(own_code == 0 & agglvl_code == 70 & is.na(disclosure_code)) %>% # All ownership types, county-level, un-suppressed
  select(area_fips, employment_all_industries = month3_emplvl)

# Private, (1026 Leisure and hospitality)[https://www.bls.gov/iag/tgs/iag70.htm], All Counties, 2019 Third Quarter, All establishment sizes
counties_leisure_hospitality <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/1026.csv") %>% 
  filter(own_code == 5 & agglvl_code == 73) %>% # Privately-owned, county-level
  select(area_fips, employment_leisure_hospitality = month3_emplvl, employment_leisure_hospitality_lq = lq_month3_emplvl)

# Import 2017 health insurance data from the Census Bureau's (Small Area Health Insurance Estimates)[https://www.census.gov/programs-surveys/sahie/data/datasets.html]
counties_health_insurance <- read_csv("data/sahie_2017.csv", skip = 79) %>% 
  filter(geocat == "50" & agecat == "0" & sexcat == "0" & (iprcat == "0" | iprcat == "3")) %>% 
  mutate(area_fips = paste0(statefips, countyfips)) %>% 
  # Reshape the data from "long" to "wide" format
  pivot_wider(id_cols = c(area_fips, county_name, state_name),
              names_from = "iprcat",
              values_from = c("NUI", "PCTUI")) %>% 
  select(area_fips,
         county_name,
         state_name,
         num_uninsured_total = NUI_0,
         num_uninsured_138_below_poverty = NUI_3,
         pct_uninsured_total = PCTUI_0,
         pct_uninsured_138_below_poverty = PCTUI_3)

# Import 2014-2018 race and ethnicity data from the Census Bureau's American Community Survey
race <- read_csv("data/acs_race_eth_2018.csv")
# Drop the duplicate header row
race <- race[-1,]
# Convert the columns to numeric
race$B03002_001E <- as.numeric(as.character(race$B03002_001E))
race$B03002_003E <- as.numeric(as.character(race$B03002_003E))
# Drop unnecessary columns
race <- race %>% 
  mutate(area_fips = substr(GEO_ID, 10, 15),
         pct_white = round(B03002_003E / B03002_001E * 100, digits = 1),
         pct_non_white = round((B03002_001E - B03002_003E) / B03002_001E * 100, digits = 1)) %>% 
  select(area_fips, pop_total = B03002_001E, pct_white, pct_non_white)

# State-level data

# Import 2019 third quarter data from (BLS's Quarterly Census of Employment and Wages (QCEW))[https://data.bls.gov/cew/apps/data_views/data_views.htm#tab=Tables]

# Total Covered, 10 Total, all industries, All Counties 2019 Third Quarter, All establishment sizes
states_all_industries <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/10.csv") %>% 
  filter(own_code == 0 & agglvl_code == 50 & is.na(disclosure_code)) %>% # All ownership types, state-level, un-suppressed
  mutate(area_fips = substr(area_fips, 1, 2)) %>% 
  select(area_fips, employment_all_industries = month3_emplvl)

# Private, (1026 Leisure and hospitality)[https://www.bls.gov/iag/tgs/iag70.htm], All Counties, 2019 Third Quarter, All establishment sizes
states_leisure_hospitality <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/1026.csv") %>% 
  filter(own_code == 5 & agglvl_code == 53) %>% # Privately-owned, state-level
  mutate(area_fips = substr(area_fips, 1, 2)) %>% 
  select(area_fips, employment_leisure_hospitality = month3_emplvl, employment_leisure_hospitality_lq = lq_month3_emplvl)

# Import 2017 health insurance data from the Census Bureau's (Small Area Health Insurance Estimates)[https://www.census.gov/programs-surveys/sahie/data/datasets.html]
states_health_insurance <- read_csv("data/sahie_2017.csv", skip = 79) %>% 
  filter(geocat == "40" & agecat == "0" & sexcat == "0" & (iprcat == "0" | iprcat == "3")) %>% 
  mutate(racecat = recode(racecat, '0' = "all_races", '1' = "white", '2' = "black", '3' = "hispanic"),
         iprcat = recode(iprcat, '0' = "all_incomes", '3' = "138_below_poverty")) %>% 
  # Reshape the data from "long" to "wide" format
  pivot_wider(id_cols = c(statefips, state_name),
              names_from = c("racecat", "iprcat"),
              values_from = c("NIPR", "NUI", "PCTUI")) %>% 
  mutate(num_uninsured_non_white = NUI_all_races_all_incomes - NUI_white_all_incomes,
         pct_uninsured_non_white = round((NUI_all_races_all_incomes - NUI_white_all_incomes) / (NIPR_all_races_all_incomes - NIPR_white_all_incomes) * 100, digits = 1)) %>% 
  select(area_fips = statefips,
         state_name,
         num_uninsured_total = NUI_all_races_all_incomes,
         num_uninsured_138_below_poverty = NUI_all_races_138_below_poverty,
         num_uninsured_white = NUI_white_all_incomes,
         num_uninsured_non_white,
         num_uninsured_black = NUI_black_all_incomes,
         num_uninsured_hispanic = NUI_hispanic_all_incomes,
         pct_uninsured_total = PCTUI_all_races_all_incomes,
         pct_uninsured_138_below_poverty = PCTUI_all_races_138_below_poverty,
         pct_uninsured_white = PCTUI_white_all_incomes,
         pct_uninsured_non_white,
         pct_uninsured_black = PCTUI_black_all_incomes,
         pct_uninsured_hispanic = PCTUI_hispanic_all_incomes)
```

```{r reshape data, echo = FALSE}
# Set variables for nationwide employment figures
us_employment_leisure_hospitality = 16575977 # https://data.bls.gov/cew/apps/table_maker/v4/table_maker.htm#type=1&year=2019&qtr=3&own=5&ind=1026&supp=1
us_employment_all_industries = 148556525 # https://data.bls.gov/cew/apps/table_maker/v4/table_maker.htm#type=1&year=2019&qtr=3&own=0&ind=10&supp=1

# Join the county-level leisure and hospitality and health insurance data frames
counties_leisure_hospitality_insurance <- list(counties_leisure_hospitality, counties_all_industries, counties_health_insurance, race) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(employment_leisure_hospitality_pct_total = round(employment_leisure_hospitality / employment_all_industries * 100, digits = 1),
         employment_plus_uninsured = employment_leisure_hospitality_pct_total + pct_uninsured_total) %>% 
  filter(!is.na(employment_leisure_hospitality_pct_total)) %>% 
  select(area_fips,
         county_name,
         state_name,
         pop_total,
         pct_non_white,
         pct_uninsured_total,
         employment_leisure_hospitality,
         employment_leisure_hospitality_pct_total,
         employment_plus_uninsured,
         employment_leisure_hospitality_lq)

# Join the state-level leisure and hospitality and health insurance data frames
states_leisure_hospitality_insurance <- list(states_leisure_hospitality, states_all_industries, states_health_insurance) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(employment_leisure_hospitality_pct_total = round(employment_leisure_hospitality / employment_all_industries * 100, digits = 1),
         employment_plus_uninsured = employment_leisure_hospitality_pct_total + pct_uninsured_total) %>% 
  filter(!is.na(employment_leisure_hospitality_pct_total)) %>% 
    select(1, 5, 12:17, 2, 18:19, 3)

# Export the data
write_csv(counties_leisure_hospitality_insurance, "data/exported/counties_leisure_hospitality_insurance.csv")
write_csv(states_leisure_hospitality_insurance, "data/exported/states_leisure_hospitality_insurance.csv")
```

```{r analyze the data, echo = FALSE}
# Which counties are more reliant on these industries for jobs than the nation as a whole?
more_reliant <- selected_industries %>% 
  filter(september_employment_lq_selected_industries > 1)

# Which counties have a rate of uninsured residents higher than the nation as a whole?
more_uninsured <- health_insurance %>% 
  filter(pct_uninsured_total > 10) # [2018 national rate of uninsurance among residents under the age of 65 = 10%](https://www.census.gov/data/tables/2019/demo/health-insurance/p60-267.html)

# Which counties meet both conditions?
more_reliant_uninsured <- more_reliant %>% 
  inner_join(more_uninsured, by = "area_fips") %>% 
  select(area_fips,
         county = county.x,
         state = state.x,
         population = population.x,
         pct_non_white = pct_non_white.x,
         num_uninsured_total = num_uninsured_total.x,
         pct_uninsured_total = pct_uninsured_total.x,
         september_employment_selected_industries,
         september_jobs_per_thousand_selected_industries,
         september_employment_lq_selected_industries)

# Which counties have the highest combined reliance on these industries and uninsured rate?
most_reliant_uninsured <- selected_industries %>% 
  arrange(desc(september_jobs_pct_total_selected_industries_plus_pct_uninsured_total)) %>% 
  head(100)

# What do these numbers look like by state?
selected_industries_by_state <- selected_industries %>% 
  mutate(state_code = substr(area_fips, 1, 2))
         
selected_industries_by_state <- selected_industries_by_state %>% 
  left_join(health_insurance_states, by = "state_code", suffix = c("_county", "_state")) %>% 
  group_by(state) %>% 
  summarize(september_employment_selected_industries_state = sum(september_employment_selected_industries),
         september_jobs_per_thousand_selected_industries_state = round((sum(september_employment_selected_industries) / sum(september_employment_all_industries)) * 1000, digits = 0),
         september_jobs_pct_total_selected_industries_state = round((sum(september_employment_selected_industries) / sum(september_employment_all_industries)) * 100, digits = 1),
         september_employment_transportation,
         september_jobs_per_thousand_transportation,
         september_jobs_pct_total_transportation,
         september_jobs_pct_total_transportation_plus_pct_uninsured_total,
         september_employment_arts_ent_rec,
         september_jobs_per_thousand_arts_ent_rec,
         september_jobs_pct_arts_ent_rec,
         september_jobs_pct_arts_ent_rec_plus_pct_uninsured_total,
         september_employment_accom_food,
         september_jobs_per_thousand_accom_food,
         september_jobs_pct_total_accom_food)





write_csv(most_reliant_uninsured, "data/exported/most_reliant_uninsured.csv")

# Do counties with a larger proportion of non-white residents tend to have higher uninsured rates?
attach(health_insurance)
plot(pct_non_white, pct_uninsured_total, main = "Percent Non-White vs. Percent Uninsured",
   xlab="Percent Non-White", ylab="Percent Uninsured", pch=19)
abline(lm(pct_uninsured_total ~ pct_non_white), col = "red") # regression line (y~x)

# Which counties have the highest ratio of jobs-per-thousand to percentage uninsured?
more_reliant_uninsured_test <- selected_industries %>% 
  mutate(september_jobs_per_thousand_to_pct_uninsured = september_jobs_per_thousand_selected_industries / pct_uninsured_total)

# Export the data
write_csv(more_reliant, "data/exported/more_reliant.csv")
write_csv(more_uninsured, "data/exported/more_uninsured.csv")
write_csv(more_reliant_uninsured, "data/exported/more_reliant_uninsured.csv")
```