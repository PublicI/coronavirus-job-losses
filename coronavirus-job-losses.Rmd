---
title: "coronavirus-job-losses"
author: "Joe Yerardi"
date: "3/23/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set working directory
setwd("/home/joe/Projects/coronavirus-job-losses//")
```

```{r import packages, echo = FALSE}
library("dplyr")
library("ggplot2")
library("htmltools")
library("purrr")
library("readr")
library("sf")
library("stringr")
library("tidyr")
library("leaflet")
library("tigris")
```

```{r import data, echo = FALSE}
# Import (BLS's Quarterly Census of Employment and Wages (QCEW))[https://data.bls.gov/cew/apps/data_views/data_views.htm#tab=Tables] data

# Total Covered, 10 Total, all industries, All Counties 2019 Third Quarter, All establishment sizes
all_industries <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/10.csv") %>% 
  filter(own_code == 0 & agglvl_code == 70 & is.na(disclosure_code)) %>% # All ownership types, county-level, un-suppressed
  select(area_fips, september_employment_all_industries = month3_emplvl, total_qtrly_wages_all_industries = total_qtrly_wages)

# Private, NAICS 481 Air transportation, All Counties, 2019 Third Quarter, All establishment sizes
air_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/481.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 482 Rail transportation, All Counties, 2019 Third Quarter, All establishment sizes
rail_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/482.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 483 Water transportation, All Counties, 2019 Third Quarter, All establishment sizes
water_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/483.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 485 Transit and ground passenger transportation, All Counties, 2019 Third Quarter, All establishment sizes
transit_ground_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/485.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 487 Scenic and sightseeing transportation, All Counties, 2019 Third Quarter, All establishment sizes
scenic_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/487.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 488 Support activities for transportation, All Counties, 2019 Third Quarter, All establishment sizes
support_activities_transport <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/488.csv") %>% 
  filter(own_code == 5 & agglvl_code == 75) %>% # Privately-owned, county-level
  select(area_fips, september_employment = month3_emplvl, total_qtrly_wages)

# Private, NAICS 71 Arts, entertainment, and recreation, All Counties, 2019 Third Quarter, All establishment sizes
arts_ent_rec <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/71.csv") %>% 
  filter(own_code == 5 & agglvl_code == 74) %>% # Privately-owned, county-level
  select(area_fips, september_employment_arts_ent_rec = month3_emplvl, total_qtrly_wages_arts_ent_rec = total_qtrly_wages, september_employment_lq_arts_ent_rec = lq_month3_emplvl, total_qtrly_wages_lq_arts_ent_rec = lq_total_qtrly_wages)

# Private, NAICS 72 Accommodation and food services, All Counties, 2019 Third Quarter, All establishment sizes
accom_food <- read_csv("https://data.bls.gov/cew/data/api/2019/3/industry/72.csv") %>% 
  filter(own_code == 5 & agglvl_code == 74) %>% # Privately-owned, county-level
  select(area_fips, september_employment_accom_food = month3_emplvl, total_qtrly_wages_accom_food = total_qtrly_wages, september_employment_lq_accom_food = lq_month3_emplvl, total_qtrly_wages_lq_accom_food = lq_total_qtrly_wages)

# Import 2017 health insurance data from the Census Bureau's (Small Area Health Insurance Estimates)[https://www.census.gov/programs-surveys/sahie/data/datasets.html]
health_insurance <- read_csv("data/sahie_2017.csv", skip = 79) %>% 
  filter(geocat == "50" & (iprcat == "0" | iprcat == "5") & (agecat == "0" | agecat == "3") & sexcat == "0") %>% 
  mutate(area_fips = paste0(statefips, countyfips)) %>% 
  # Reshape the data from "long" to "wide" format
  pivot_wider(id_cols = area_fips,
              names_from = c("iprcat", "agecat"),
              values_from = c("NUI", "PCTUI")) %>% 
  select(area_fips,
         num_uninsured_total = NUI_0_0,
         num_uninsured_138_400_poverty = NUI_5_0,
         num_uninsured_age_50_up = NUI_0_3,
         pct_uninsured_total = PCTUI_0_0,
         pct_uninsured_138_400_poverty = PCTUI_5_0,
         pct_uninsured_age_50_up = PCTUI_0_3)

# And import it for states
health_insurance_states <- read_csv("data/sahie_2017.csv", skip = 79) %>% 
  filter(geocat == "40" & (iprcat == "0" | iprcat == "3") & agecat == "0" & sexcat == "0") %>% 
  # Reshape the data from "long" to "wide" format
  pivot_wider(id_cols = statefips,
              names_from = c("iprcat", "racecat"),
              values_from = c("NUI", "PCTUI")) %>% 
  select(state_code = statefips,
         num_uninsured_total = NUI_0_0,
         num_uninsured_138_poverty = NUI_3_0,
         num_uninsured_white = NUI_0_1,
         num_uninsured_138_poverty_white = NUI_3_1,
         num_uninsured_black = NUI_0_2,
         num_uninsured_138_poverty_black = NUI_3_2,
         num_uninsured_hispanic = NUI_0_3,
         num_uninsured_138_poverty_hispanic = NUI_3_3,
         pct_uninsured_total = PCTUI_0_0,
         pct_uninsured_138_poverty = PCTUI_3_0,
         pct_uninsured_white = PCTUI_0_1,
         pct_uninsured_138_poverty_white = PCTUI_3_1,
         pct_uninsured_black = PCTUI_0_2,
         pct_uninsured_138_poverty_black = PCTUI_3_2,
         pct_uninsured_hispanic = PCTUI_0_3,
         pct_uninsured_138_poverty_hispanic = PCTUI_3_3)

# Add state names
health_insurance_states <- health_insurance_states %>% 
  left_join(fips_codes, by = "state_code") %>% 
  select(state_code,
         state_name,
         num_uninsured_total,
         num_uninsured_138_poverty,
         num_uninsured_white,
         num_uninsured_138_poverty_white,
         num_uninsured_black,
         num_uninsured_138_poverty_black,
         num_uninsured_hispanic,
         num_uninsured_138_poverty_hispanic,
         pct_uninsured_total,
         pct_uninsured_138_poverty,
         pct_uninsured_white,
         pct_uninsured_138_poverty_white,
         pct_uninsured_black,
         pct_uninsured_138_poverty_black,
         pct_uninsured_hispanic,
         pct_uninsured_138_poverty_hispanic)

# Remove duplicate rows
health_insurance_states <- distinct(health_insurance_states)

# Import 2018 county population data from the Census Bureau's American Community Survey
county_pops <- read_csv("data/acs_pops_2018.csv")
# Drop the duplicate header row
county_pops <- county_pops[-1,]
# Convert the population column to numeric
county_pops$B01003_001E <- as.numeric(as.character(county_pops$B01003_001E))
# Create separate county and state columns
county_pops$county = separate(data = county_pops, col = NAME, into = c("county", "state"), sep = ", ", remove = T)[, 2]
county_pops$state = separate(data = county_pops, col = NAME, into = c("county", "state"), sep = ", ", remove = T)[, 3]
# Drop unnecessary columns
county_pops <- county_pops %>% 
  mutate(area_fips = substr(GEO_ID, 10, 15),
         county = unlist(county, use.names = T),
         state = unlist(state, use.names = T)) %>% 
  select(area_fips, county, state, population = B01003_001E)

# Import 2014-2018 race and ethnicity data from the Census Bureau's American Community Survey
race <- read_csv("data/acs_race_eth_2018.csv")
# Drop the duplicate header row
race <- race[-1,]
# Convert the columns to numeric
race$B03002_001E <- as.numeric(as.character(race$B03002_001E))
race$B03002_003E <- as.numeric(as.character(race$B03002_003E))
# Drop unnecessary columns
race <- race %>% 
  mutate(area_fips = substr(GEO_ID, 10, 15),
         pct_white = round(B03002_003E / B03002_001E * 100, digits = 1),
         pct_non_white = round((B03002_001E - B03002_003E) / B03002_001E * 100, digits = 1)) %>% 
  select(area_fips, pct_white, pct_non_white)
```

```{r reshape data, echo = FALSE}
# Set variables for nationwide employment and wages figures
us_september_employment_transportation = 507269 + 392 + 68165 + 499236 + 39260 + 742948
us_total_qtrly_wages_transportation = 11047760728 + 6158160 + 1428003244 + 4492040626 + 373221276 + 10654939055

us_september_employment_arts_ent_rec = 2467659
us_total_qtrly_wages_arts_ent_rec = 24359411562

us_september_employment_accom_food = 14108318
us_total_qtrly_wages_accom_food = 80885211645

us_september_employment_selected_industries = us_september_employment_transportation + us_september_employment_arts_ent_rec + us_september_employment_accom_food
us_total_qtrly_wages_selected_industries = us_total_qtrly_wages_transportation + us_total_qtrly_wages_arts_ent_rec + us_total_qtrly_wages_accom_food

us_september_employment_all_industries = 148556525
us_total_qtrly_wages_all_industries = 2101499510734

# Join the transportation data frames for the three-digit NAICS categories together and with the other data frame
transportation <- list(air_transport, rail_transport, water_transport, transit_ground_transport, scenic_transport, support_activities_transport, all_industries, county_pops, health_insurance, race) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(september_employment_transportation = select(., 2, 4, 6, 8, 10, 12) %>% 
           rowSums(na.rm = T),
         september_jobs_per_thousand_transportation = round(september_employment_transportation / september_employment_all_industries * 1000, digits = 0),
         september_jobs_pct_total_transportation = round(september_employment_transportation / september_employment_all_industries * 100, digits = 1),
         september_jobs_pct_total_transportation_plus_pct_uninsured_total = september_jobs_pct_total_transportation + pct_uninsured_total,
         september_employment_all_industries,
         september_employment_lq_transportation = round((september_employment_transportation / september_employment_all_industries) / (us_september_employment_transportation / us_september_employment_all_industries), digits = 2)) %>% 
  filter(!is.na(september_jobs_per_thousand_transportation)) %>% 
  select(area_fips,
         county,
         state,
         population,
         pct_non_white,
         num_uninsured_total,
         pct_uninsured_total,
         september_employment_transportation,
         september_jobs_per_thousand_transportation,
         september_jobs_pct_total_transportation,
         september_jobs_pct_total_transportation_plus_pct_uninsured_total,
         september_employment_all_industries,
         september_employment_lq_transportation)

# Join the arts, entertainment and recreation industry data frame with the other data frames
arts_ent_rec <- list(arts_ent_rec, all_industries, county_pops, health_insurance, race) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(september_jobs_per_thousand_arts_ent_rec = round(september_employment_arts_ent_rec / september_employment_all_industries * 1000, digits = 0),
         september_jobs_pct_arts_ent_rec = round(september_employment_arts_ent_rec / september_employment_all_industries * 100, digits = 1),
         september_jobs_pct_arts_ent_rec_plus_pct_uninsured_total = september_jobs_pct_arts_ent_rec + pct_uninsured_total) %>% 
  filter(!is.na(september_jobs_per_thousand_arts_ent_rec)) %>% 
  select(area_fips,
         county,
         state,
         population,
         pct_non_white,
         num_uninsured_total,
         pct_uninsured_total,
         september_employment_arts_ent_rec,
         september_jobs_per_thousand_arts_ent_rec,
         september_jobs_pct_arts_ent_rec,
         september_jobs_pct_arts_ent_rec_plus_pct_uninsured_total,
         september_employment_all_industries,
         september_employment_lq_arts_ent_rec)

# Join the accomodation and food services industry data frame with the other data frames
accom_food <- list(accom_food, all_industries, county_pops, health_insurance, race) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(september_jobs_per_thousand_accom_food = round(september_employment_accom_food / september_employment_all_industries * 1000, digits = 0),
         september_jobs_pct_total_accom_food = round(september_employment_accom_food / september_employment_all_industries * 100, digits = 1),
         september_jobs_pct_total_accom_food_plus_pct_uninsured_total = september_jobs_pct_total_accom_food + pct_uninsured_total) %>% 
  filter(!is.na(september_jobs_per_thousand_accom_food)) %>% 
  select(area_fips,
         county,
         state,
         population,
         pct_non_white,
         num_uninsured_total,
         pct_uninsured_total,
         september_employment_accom_food,
         september_jobs_per_thousand_accom_food,
         september_jobs_pct_total_accom_food,
         september_jobs_pct_total_accom_food_plus_pct_uninsured_total,
         september_employment_all_industries,
         september_employment_lq_accom_food)

# Join all the selected industries data frames together
selected_industries <- list(transportation, arts_ent_rec, accom_food) %>% 
  reduce(full_join, by = "area_fips") %>% 
  mutate(september_employment_selected_industries = select(., 8, 20, 33) %>% 
           rowSums(na.rm = T),
         september_jobs_per_thousand_selected_industries = round(september_employment_selected_industries / september_employment_all_industries * 1000, digits = 0),
         september_jobs_pct_total_selected_industries = round(september_employment_selected_industries / september_employment_all_industries * 100, digits = 1),
         september_jobs_pct_total_selected_industries_plus_pct_uninsured_total = september_jobs_pct_total_selected_industries + pct_uninsured_total,
         september_employment_lq_selected_industries = round((september_employment_selected_industries / september_employment_all_industries) / (us_september_employment_selected_industries / us_september_employment_all_industries), digits = 2)) %>% 
  filter(!is.na(september_jobs_per_thousand_selected_industries)) %>% 
  select(area_fips,
         county,
         state,
         population,
         pct_non_white,
         num_uninsured_total,
         pct_uninsured_total,
         september_employment_selected_industries,
         september_jobs_per_thousand_selected_industries,
         september_jobs_pct_total_selected_industries,
         september_jobs_pct_total_selected_industries_plus_pct_uninsured_total,
         september_employment_transportation,
         september_jobs_per_thousand_transportation,
         september_jobs_pct_total_transportation,
         september_jobs_pct_total_transportation_plus_pct_uninsured_total,
         september_employment_arts_ent_rec,
         september_jobs_per_thousand_arts_ent_rec,
         september_jobs_pct_arts_ent_rec,
         september_jobs_pct_arts_ent_rec_plus_pct_uninsured_total,
         september_employment_accom_food,
         september_jobs_per_thousand_accom_food,
         september_jobs_pct_total_accom_food,
         september_jobs_pct_total_accom_food_plus_pct_uninsured_total,
         september_employment_all_industries,
         september_employment_lq_selected_industries)

# Join the health insurance and county population and race data frames
health_insurance <- list(health_insurance, county_pops, race) %>% 
  reduce(full_join, by = "area_fips") %>% 
  filter(!is.na(pct_uninsured_total)) %>% 
  select(area_fips,
         county,
         state,
         population,
         pct_non_white,
         num_uninsured_total,
         num_uninsured_138_400_poverty,
         num_uninsured_age_50_up,
         pct_uninsured_total,
         pct_uninsured_138_400_poverty,
         pct_uninsured_age_50_up)

# Export the data
write_csv(transportation, "data/exported/transportation.csv")
write_csv(arts_ent_rec, "data/exported/arts_ent_rec.csv")
write_csv(accom_food, "data/exported/accom_food.csv")
write_csv(selected_industries, "data/exported/selected_industries.csv")
write_csv(health_insurance, "data/exported/health_insurance.csv")
```

```{r analyze the data, echo = FALSE}
# Which counties are more reliant on these industries for jobs than the nation as a whole?
more_reliant <- selected_industries %>% 
  filter(september_employment_lq_selected_industries > 1)

# Which counties have a rate of uninsured residents higher than the nation as a whole?
more_uninsured <- health_insurance %>% 
  filter(pct_uninsured_total > 10) # [2018 national rate of uninsurance among residents under the age of 65 = 10%](https://www.census.gov/data/tables/2019/demo/health-insurance/p60-267.html)

# Which counties meet both conditions?
more_reliant_uninsured <- more_reliant %>% 
  inner_join(more_uninsured, by = "area_fips") %>% 
  select(area_fips,
         county = county.x,
         state = state.x,
         population = population.x,
         pct_non_white = pct_non_white.x,
         num_uninsured_total = num_uninsured_total.x,
         pct_uninsured_total = pct_uninsured_total.x,
         september_employment_selected_industries,
         september_jobs_per_thousand_selected_industries,
         september_employment_lq_selected_industries)

# Which counties have the highest combined reliance on these industries and uninsured rate?
most_reliant_uninsured <- selected_industries %>% 
  arrange(desc(september_jobs_pct_total_selected_industries_plus_pct_uninsured_total)) %>% 
  head(100)

# What do these numbers look like by state?
selected_industries_by_state <- selected_industries %>% 
  mutate(state_code = substr(area_fips, 1, 2))
         
selected_industries_by_state <- selected_industries_by_state %>% 
  left_join(health_insurance_states, by = "state_code", suffix = c("_county", "_state")) %>% 
  group_by(state) %>% 
  summarize(september_employment_selected_industries_state = sum(september_employment_selected_industries),
         september_jobs_per_thousand_selected_industries_state = round((sum(september_employment_selected_industries) / sum(september_employment_all_industries)) * 1000, digits = 0),
         september_jobs_pct_total_selected_industries_state = round((sum(september_employment_selected_industries) / sum(september_employment_all_industries)) * 100, digits = 1),
         september_employment_transportation,
         september_jobs_per_thousand_transportation,
         september_jobs_pct_total_transportation,
         september_jobs_pct_total_transportation_plus_pct_uninsured_total,
         september_employment_arts_ent_rec,
         september_jobs_per_thousand_arts_ent_rec,
         september_jobs_pct_arts_ent_rec,
         september_jobs_pct_arts_ent_rec_plus_pct_uninsured_total,
         september_employment_accom_food,
         september_jobs_per_thousand_accom_food,
         september_jobs_pct_total_accom_food)





write_csv(most_reliant_uninsured, "data/exported/most_reliant_uninsured.csv")

# Do counties with a larger proportion of non-white residents tend to have higher uninsured rates?
attach(health_insurance)
plot(pct_non_white, pct_uninsured_total, main = "Percent Non-White vs. Percent Uninsured",
   xlab="Percent Non-White", ylab="Percent Uninsured", pch=19)
abline(lm(pct_uninsured_total ~ pct_non_white), col = "red") # regression line (y~x)

# Which counties have the highest ratio of jobs-per-thousand to percentage uninsured?
more_reliant_uninsured_test <- selected_industries %>% 
  mutate(september_jobs_per_thousand_to_pct_uninsured = september_jobs_per_thousand_selected_industries / pct_uninsured_total)

# Export the data
write_csv(more_reliant, "data/exported/more_reliant.csv")
write_csv(more_uninsured, "data/exported/more_uninsured.csv")
write_csv(more_reliant_uninsured, "data/exported/more_reliant_uninsured.csv")
```